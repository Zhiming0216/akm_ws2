cmake_minimum_required(VERSION 3.5)
project(ndt_omp_ros2)

# åŸºç¡€è®¾ç½®
if(NOT CMAKE_CXX_STANDARD)
  set(CMAKE_CXX_STANDARD 14)
endif()
set(CMAKE_BUILD_TYPE "RELEASE")

# 1. æŸ¥æ‰¾ä¾èµ–
find_package(ament_cmake REQUIRED)
find_package(rclcpp REQUIRED)
find_package(std_msgs REQUIRED)
find_package(pcl_conversions REQUIRED) # å»ºè®®åŠ ä¸Šè¿™ä¸ª

# PCL æŸ¥æ‰¾ (å»æ‰ç‰ˆæœ¬å·é™åˆ¶ï¼Œæé«˜å…¼å®¹æ€§)
find_package(PCL REQUIRED)
add_definitions(${PCL_DEFINITIONS})

# OpenMP æŸ¥æ‰¾
find_package(OpenMP)
if (OPENMP_FOUND)
    set (CMAKE_C_FLAGS "${CMAKE_C_FLAGS} ${OpenMP_C_FLAGS}")
    set (CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} ${OpenMP_CXX_FLAGS}")
endif()

# 2. åŒ…å«è·¯å¾„
include_directories(
  include
  ${PCL_INCLUDE_DIRS}
)

# 3. ç¼–è¯‘åº“ (å…³é”®ä¿®æ”¹ï¼šæ˜¾å¼å£°æ˜ SHARED ç”Ÿæˆ .so æ–‡ä»¶)
add_library(ndt_omp SHARED
  src/pclomp/voxel_grid_covariance_omp.cpp
  src/pclomp/ndt_omp.cpp
  src/pclomp/gicp_omp.cpp
)

# é“¾æ¥ä¾èµ–
target_link_libraries(ndt_omp
  ${PCL_LIBRARIES}
)

# 4. ç¼–è¯‘æµ‹è¯•ç¨‹åº (align)
add_executable(align apps/align.cpp)
target_link_libraries(align
  ndt_omp
  ${PCL_LIBRARIES}
)
ament_target_dependencies(align
  rclcpp
  std_msgs
)

# 5. å®‰è£…è§„åˆ™ (ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šè¿™é‡Œå¿…é¡»è¦æŠŠåº“æ–‡ä»¶ ndt_omp è£…è¿›å»)
install(TARGETS 
  ndt_omp    # <--- åŸæ–‡ä»¶æ¼æ‰äº†è¿™ä¸ªï¼
  align
  ARCHIVE DESTINATION lib
  LIBRARY DESTINATION lib
  RUNTIME DESTINATION bin
)

# å®‰è£…å¤´æ–‡ä»¶
install(DIRECTORY include/
  DESTINATION include
)

# 6. å¯¼å‡ºä¾èµ– (å‘Šè¯‰åˆ«çš„åŒ…ï¼šæˆ‘æœ‰ ndt_omp è¿™ä¸ªåº“)
ament_export_include_directories(include)
ament_export_libraries(ndt_omp)       # <--- åŠ ä¸Šè¿™ä¸€è¡Œ
ament_export_dependencies(rclcpp PCL) # <--- åŠ ä¸Š PCL

ament_package()